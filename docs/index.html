<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">



<section id="casa0025-group-project-heat-stress-vulnerability-index-hsvi" class="level1 page-columns page-full">
<h1>CASA0025 Group Project – Heat Stress Vulnerability Index (HSVI)</h1>
<section id="project-summary" class="level2">
<h2 class="anchored" data-anchor-id="project-summary">Project Summary</h2>
<p><em>Fill in the sections below to provide a brief summary of your project. Each section should have no more than 100 words. Do not edit any of the headings.</em></p>
<section id="problem-statement" class="level3">
<h3 class="anchored" data-anchor-id="problem-statement">Problem Statement</h3>
<p><em>What is the problem you’re trying to address using this application?</em></p>
<p>Urban areas are becoming increasingly warmer than their surrounding areas known as the Urban Heat Island (UHI) effect (Wu et al., 2021). Moreover, heat stress is the leading cause of weather-related deaths and can exacerbate underlying illnesses (WHO, 2024). Studies have shown that estimates of heat-related mortality vary significantly depending on whether residents are assumed to acclimatise to local or city-wide temperatures (Shindell, 2024). Therefore, a web application that integrates temperature data, acclimatisation factors, and demographic vulnerability at a higher resolution would improve localised policy improvements and safety measures.</p>
</section>
<section id="end-user" class="level3">
<h3 class="anchored" data-anchor-id="end-user">End User</h3>
<p><em>Who are you building this application for? How does it address a need this community has?</em></p>
<p>This application is designed for various stakeholders who play a role in protecting London from extreme heat. These include governing authorities, public health bodies, and infrastructure providers. ​​It allows users to identify heat hotspots across the city in near real-time. This improves on static snapshot data (Arup, 2024), enabling more dynamic heat risk management. The application can also be used to inform city-wide policies, and enable localised public health responses during heat waves. Finally, it can be used to evaluate how infrastructure impacts heat stress and encourage precautionary and safety measures.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p><em>What data are you using?</em></p>
<p>Geospatial datasets from various sources are used: Sentinel-2 satellite imagery for NDVI (vegetation health), Landsat 8 Tier 1 for land surface temperature, Ordnance Survey for building mass density, and Nomis census data to capture old age demographics. These datasets are integrated and analysed to produce an index of heat vulnerability across urban areas.</p>
<table class="table">
<thead>
<tr class="header">
<th>Layer/Factor</th>
<th>Dataset</th>
<th>Resolution</th>
<th>Timeframe</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Population density (elderly)</td>
<td>census2021-ts007-msoa.csv</td>
<td>Vector (MSOA)</td>
<td>As at 2021</td>
<td><a href="https://www.nomisweb.co.uk/sources/census_2021_bulk">ONS Census 2021</a></td>
</tr>
<tr class="even">
<td>NDVI</td>
<td>Sentinel 2 Bands 4 and 8</td>
<td>10m</td>
<td>3-4 days</td>
<td><a href="https://developers.google.com/earth-engine/datasets/catalog/sentinel-2">Earth Engine Data Catalog Sentinel-2</a></td>
</tr>
<tr class="odd">
<td>Temperature (LST)</td>
<td>Landsat 8 Surface Temperature Band 10</td>
<td>30m</td>
<td>16 days ; Month filter:6-9</td>
<td><a href="https://developers.google.com/earth-engine/datasets/catalog/LANDSAT_LC08_C02_T1_L2">Earth Engine Data Catalog Landsat 8</a></td>
</tr>
<tr class="even">
<td>Building height and density</td>
<td>Ordnance Survey National Geographic Database (OS NGD) Buildings</td>
<td>vector</td>
<td>2025</td>
<td><a href="https://docs.os.uk/osngd/data-structure/buildings">OS NGD Documentation</a></td>
</tr>
</tbody>
</table>
</section>
<section id="methodology" class="level3">
<h3 class="anchored" data-anchor-id="methodology">Methodology</h3>
<p><em>How are you using this data to address the problem?</em></p>
<p>This application was built using Streamlit and integrates with Google Earth Engine (GEE). Data is fetched from GEE (Sentinel-2 for vegetation, Landsat 8 for temperature), OS NGD and the UK census. The index was created by first inverting the NDVI values, since more vegetation lowers heat risk, and then scaling all datasets between 0 and 1 using MinMaxScaler before combining them. Every factor is then weighted equally at 25%, and the weighted scores are summed to generate a final Heat Stress Vulnerability Index (HSVI). The results are then presented through an interactive map, enabling stakeholders to identify areas most at risk.</p>
</section>
<section id="interface" class="level3">
<h3 class="anchored" data-anchor-id="interface">Interface</h3>
<p><em>How does your application’s interface work to address the needs of your end user?</em></p>
<p>The interface features a dual-panel design for HSVI calculation. The left-control panel allows users to select data aggregated at different geographic levels (LAD or council), date ranges, and map topics (overall index or specific factors like NDVI, temperature, elderly population, and building mass density). The right panel displays responsive interactive choropleth maps and bar charts showing top 10 areas needing prior actions to tackle heat stress. Users can also download CSV files for external analysis. This design helps users identify vulnerable communities and understand specific heat-risk factors, supporting future interventions.</p>
</section>
</section>
<section id="the-application" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-application">The Application</h2>
<p>Each time users change map layers in application, please use “Reset APP” botton to refresh the page to avoid cache problmes.</p>
<p><a href="https://casa0025-test.streamlit.app">Application Website: https://casa0025-test.streamlit.app</a></p>
<div class="column-page">
<iframe src="https://casa0025-test.streamlit.app/?embed=true" width="100%" height="700px">
</iframe>
</div>
</section>
<section id="how-it-works" class="level2">
<h2 class="anchored" data-anchor-id="how-it-works">How it Works</h2>
<p><em>Use this section to explain how your application works using code blocks and text explanations (no more than 500 words excluding code):</em></p>
<p><a href="https://github.com/tariroMashCasa/casa0025">Click here</a> to access the repo to find Home.py which includes all codes for the application.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/flowchart.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Technical Walkthrough</figcaption>
</figure>
</div>
<section id="vulnerable-population" class="level3">
<h3 class="anchored" data-anchor-id="vulnerable-population">Vulnerable Population</h3>
<p>Urban heat disproportionately affects segments of the population; people over the age of 65 represent the largest of these groups. We use this group as a proxy for vulnerable population groups within our application. The data used to size this group is from the UK 2021 Census. Data is aggregated at the lowest available level of aggregation (MSOA) and is summed together.</p>
<p>This is then divided by the total population for that location “Total Number of Usual Residents” to arrive at a Percentage of the population aged 65 and over. The rate value is used as part of the HSVI, however, in practice there are minor differences when compared to using absolute counts, so rates are preferred.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2️ Convert GeoDataFrame → EE FeatureCollection</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> st.session_state.london_boroughs_over_65 <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># now we're going to add in the vector data for the london boroughs for number of people over 65 from a geojson file</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># london_boroughs_over_65 = gp.read_file('data/london_percentage_of_population_over_65.geojson')#.head(10).to_crs(4326)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                        london_boroughs_over_65 <span class="op">=</span> pd.read_parquet(<span class="st">'data/london_percentage_of_population_over_65.parquet.gzip'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># load the lsoa level geometries</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># gdf_lsoas = pd.read_parquet('data/london_lsoas_2011_mapping_file.parquet.gzip')</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                        gdf_lsoas <span class="op">=</span> pd.read_parquet(<span class="st">'data/london_msoas_2021_mapping_file.parquet.gzip'</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># convert the wkt geometry to a shapely geometry</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                        gdf_lsoas[<span class="st">"geometry"</span>] <span class="op">=</span> gdf_lsoas[<span class="st">"geometry"</span>].<span class="bu">apply</span>(shapely.wkt.loads)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># convert this to a geodataframe</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                        gdf_lsoas <span class="op">=</span> gp.GeoDataFrame(gdf_lsoas, geometry<span class="op">=</span><span class="st">"geometry"</span>, crs<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># filter the LAD11NM column to match the users  </span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                        gdf_boroughs <span class="op">=</span> gdf_lsoas[gdf_lsoas[<span class="st">"LAD11NM"</span>] <span class="op">==</span> st.session_state.selected_council]</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                        gdf_boroughs <span class="op">=</span> gdf_boroughs[[<span class="st">"MSOA21CD"</span>]].rename(columns<span class="op">=</span>{<span class="st">"MSOA21CD"</span>:<span class="st">"geography code"</span>})</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># do a spatial join to get the vulnerable population data for the selected council</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>                        london_boroughs_over_65 <span class="op">=</span> london_boroughs_over_65.merge(gdf_boroughs, on<span class="op">=</span><span class="st">"geography code"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># convert the wkt geometry to a shapely geometry</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>                        london_boroughs_over_65[<span class="st">"geometry"</span>] <span class="op">=</span> london_boroughs_over_65[<span class="st">"geometry"</span>].<span class="bu">apply</span>(shapely.wkt.loads)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># convert this to a geodataframe</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>                        london_boroughs_over_65 <span class="op">=</span> gp.GeoDataFrame(london_boroughs_over_65, geometry<span class="op">=</span><span class="st">"geometry"</span>, crs<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># add this to session state</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>                        st.session_state.london_boroughs_over_65 <span class="op">=</span> london_boroughs_over_65</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>                        london_boroughs_over_65 <span class="op">=</span> st.session_state.london_boroughs_over_65</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># calculate the midpoint of london</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>                    london_midpoint_latitude, london_midpoint_longitude <span class="op">=</span> london_boroughs_over_65.to_crs(<span class="dv">4326</span>).geometry.centroid.y.mean(), london_boroughs_over_65.to_crs(<span class="dv">4326</span>).geometry.centroid.x.mean()</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># rename columns for the map</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                    london_boroughs_over_65 <span class="op">=</span> london_boroughs_over_65.rename(columns<span class="op">=</span>{<span class="st">"pct_over_65_pop"</span>:<span class="st">"Population over 65 %"</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                                                                                      <span class="st">"total_pop_over_65_years_old"</span>:<span class="st">"Total Population over 65"</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                                                                                      <span class="st">"total_pop"</span>:<span class="st">"Total Population"</span>})</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                    london_boroughs_over_65 <span class="op">=</span> london_boroughs_over_65.drop(columns<span class="op">=</span>[<span class="st">"date"</span>,<span class="st">"city"</span>])</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># round the % population over 65 to 2 decimal places</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                    london_boroughs_over_65[<span class="st">"Population over 65 %"</span>] <span class="op">=</span> (london_boroughs_over_65[<span class="st">"Population over 65 %"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> st.session_state.london_boroughs_over_65_map <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># we'll plot this on a folium map</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                        m <span class="op">=</span> london_boroughs_over_65.explore(<span class="st">"Population over 65 %"</span>, tiles<span class="op">=</span><span class="st">"CartoDB.Positron"</span>, cmap<span class="op">=</span><span class="st">"Blues"</span>, scheme<span class="op">=</span><span class="st">"Quantiles"</span>, legend_title<span class="op">=</span><span class="st">"Population over 65"</span>, style_kwds<span class="op">=</span>{<span class="st">'weight'</span>: <span class="dv">1</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="normalised-difference-vegetation-index-ndvi" class="level3">
<h3 class="anchored" data-anchor-id="normalised-difference-vegetation-index-ndvi">Normalised Difference Vegetation Index (NDVI)</h3>
<p>Healthy vegetation cools surrounding areas through shade and evapotranspiration which is why it is incorporated in the index. Healthy plants absorb red light and reflect near-infrared (NIR) light. NDVI captures the contrast between NIR and Red reflectance, allowing us to identify areas of healthy vegetation. Areas with NDVI values close to 1 indicate healthy vegetation, while low or negative values suggest sparse vegetation.</p>
<p>NDVI is calculated using this formula:</p>
<p><span class="math display">\[
NDVI = \frac{(NIR - Red)}{(NIR + Red)}
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(NDVI\)</span>: Normalized Difference Vegetation Index<br>
</li>
<li><span class="math inline">\(NIR\)</span>: Reflectance in the Near-Infrared band<br>
</li>
<li><span class="math inline">\(Red\)</span>: Reflectance in the Red band</li>
</ul>
<p>Sentinel-2 data was cloud-filtered and combined using the median value of the available images in GEE. NDVI values were calculated from band 4 (Red) and band 8 (Near-infrared). Then spatially aggregated by borough using a median reducer at 10m resolution.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now we're going to use the lad data to get the NDVI</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> st.session_state.gdf_results <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># 2️ Convert GeoDataFrame → EE FeatureCollection</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                        ee_boroughs <span class="op">=</span> geemap.geopandas_to_ee(gdf_boroughs, geodesic<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                        st.session_state.ee_boroughs <span class="op">=</span> ee_boroughs</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># 3️ Build Sentinel‑2 NDVI composite</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                        sentinel <span class="op">=</span> (</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                            ee.ImageCollection(<span class="st">'COPERNICUS/S2_SR'</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                            .filterBounds(ee_boroughs)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                            .filterDate(one_year_ago, today)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                            .<span class="bu">filter</span>(ee.Filter.lt(<span class="st">'CLOUDY_PIXEL_PERCENTAGE'</span>, <span class="dv">10</span>))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                            .median()</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                            .clip(ee_boroughs)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># this was the default code for the NDVI</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                        ndvi <span class="op">=</span> sentinel.normalizedDifference([<span class="st">'B8'</span>, <span class="st">'B4'</span>]).rename(<span class="st">'NDVI'</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                        st.session_state.ndvi <span class="op">=</span> ndvi</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># 4️ Sum NDVI per borough</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                        fc_results <span class="op">=</span> ndvi.reduceRegions(</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                            collection<span class="op">=</span>ee_boroughs,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                            reducer<span class="op">=</span>ee.Reducer.median(),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                            crs<span class="op">=</span><span class="st">'EPSG:27700'</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># 5️⃣Pull results client‑side as GeoJSON → GeoDataFrame</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                        geojson <span class="op">=</span> fc_results.getInfo()</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                        gdf_results <span class="op">=</span> gp.GeoDataFrame.from_features(geojson[<span class="st">'features'</span>]).rename(columns<span class="op">=</span>{<span class="st">'NAME'</span>: <span class="st">'MSOA Name'</span>,<span class="st">"median"</span>: <span class="st">"NDVI"</span>})</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># for ndvi we will need to invert these values </span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>                        gdf_results[<span class="st">"NDVI"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> gdf_results[<span class="st">"NDVI"</span>]</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>                        st.session_state.gdf_results <span class="op">=</span> gdf_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="temperature-lst" class="level3">
<h3 class="anchored" data-anchor-id="temperature-lst">Temperature (LST)</h3>
<p>Land Surface Temperature (LST) represents heat energy emitted by land, buildings, and other surfaces, serving as an indirect measure of air temperature during heat waves (United States Environmental Protection Agency, 2025). Using Landsat 8 Surface Temperature Band 10 in GEE, processed LST was derived for summer months (June-September) when peak heat conditions are experienced.</p>
<p>We filtered out cloudy images, before applying a median reducer and a water mask excluding water bodies to focus on artificial surfaces that retain more heat, relevant to urban populations. Spatial aggregation was finally done at LSOA and Borough levels.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># load the data and apply the relevant filters and functions</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#.filter(ee.Filter.calendarRange(6, 9,'month')) \  may apply a similar seasonal filter here</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> st.session_state.date_range_selection <span class="op">==</span> <span class="st">"Yes"</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                        landsat <span class="op">=</span> ee.ImageCollection(<span class="st">'LANDSAT/LC08/C02/T1_L2'</span>) <span class="op">\</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                        .filterDate(st.session_state.user_selected_start_date, st.session_state.user_selected_end_date) <span class="op">\</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">filter</span>(ee.Filter.calendarRange(<span class="dv">6</span>, <span class="dv">9</span>, <span class="st">'month'</span>))<span class="op">\</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                        .filterBounds(ee_boroughs) <span class="op">\</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">filter</span>(ee.Filter.lt(<span class="st">"CLOUD_COVER"</span>, <span class="dv">15</span>)) <span class="op">\</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">map</span>(applyScaleFactors) <span class="op">\</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                        .select(<span class="st">'ST_B10'</span>).<span class="bu">map</span>(celsius) <span class="op">\</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">reduce</span>(ee.Reducer.median()) <span class="op">\</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                        .clip(ee_boroughs)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> st.session_state.date_range_selection <span class="op">==</span> <span class="st">"No"</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                        landsat <span class="op">=</span> ee.ImageCollection(<span class="st">'LANDSAT/LC08/C02/T1_L2'</span>) <span class="op">\</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                        .filterDate(one_year_ago, today) <span class="op">\</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">filter</span>(ee.Filter.calendarRange(<span class="dv">6</span>, <span class="dv">9</span>, <span class="st">'month'</span>))<span class="op">\</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                        .filterBounds(ee_boroughs) <span class="op">\</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">filter</span>(ee.Filter.lt(<span class="st">"CLOUD_COVER"</span>, <span class="dv">15</span>)) <span class="op">\</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">map</span>(applyScaleFactors) <span class="op">\</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                        .select(<span class="st">'ST_B10'</span>).<span class="bu">map</span>(celsius) <span class="op">\</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">reduce</span>(ee.Reducer.median()) <span class="op">\</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                        .clip(ee_boroughs)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># mask out water in London to detect more accurate LST result</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Generate a water mask.</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                    water <span class="op">=</span> ee.Image(<span class="st">"JRC/GSW1_4/GlobalSurfaceWater"</span>).select(<span class="st">"occurrence"</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                    notWater <span class="op">=</span> water.mask().Not()</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                    temperature_layer <span class="op">=</span> landsat.updateMask(notWater)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                    st.session_state.temperature_layer <span class="op">=</span> temperature_layer</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># 4️ Sum NDVI per borough</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                    temperature_results <span class="op">=</span> temperature_layer.reduceRegions(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>                        collection<span class="op">=</span>ee_boroughs,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>                        reducer<span class="op">=</span>ee.Reducer.median(),</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                        scale<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                        crs<span class="op">=</span><span class="st">'EPSG:27700'</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># 5️⃣Pull results client‑side as GeoJSON → GeoDataFrame</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>                    geojson <span class="op">=</span> temperature_results.getInfo()</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>                    temperature_gdf_results <span class="op">=</span> gp.GeoDataFrame.from_features(geojson[<span class="st">'features'</span>]).rename(columns<span class="op">=</span>{<span class="st">'NAME'</span>: <span class="st">'MSOA Name'</span>,<span class="st">"median"</span>: <span class="st">"surface_temperature"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="building-mass-density" class="level3">
<h3 class="anchored" data-anchor-id="building-mass-density">Building Mass Density</h3>
<p>Densely built environments contribute to higher heat absorption and slower cooling. Therefore, Building Mass Density (BMD) is considered as part of the Urban Heat Island (UHI) index. BMD has been calculated at both the LSOA and Borough levels.</p>
<p>The Ordnance Survey National Geographic Database (OS NGD) was used as the most complete and authoritative building dataset available in Great Britain. OS NGD was chosen over OpenStreetMap (OSM) due to its more comprehensive and consistent height attribution, which is sparse and unreliable in OSM (Bernard et al., 2022).</p>
<p>BMD was calculated using the following formula:</p>
<p><span class="math display">\[
Bmd = \frac{\sum (H_i \times A_i)}{A_{admin}}
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(Bmd\)</span>: Building Mass Density</li>
<li><span class="math inline">\(H_i\)</span>: Height of building <span class="math inline">\(i\)</span> (in metres)</li>
<li><span class="math inline">\(A_i\)</span>: Footprint area of building <span class="math inline">\(i\)</span> (in square metres)</li>
<li><span class="math inline">\(A_{admin}\)</span>: Total area of the administrative region (in square metres)</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Process total building volumes per lsoa</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This is split into batches to prevent time out issues.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get list of all LSOA codes</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>lsoa_codes <span class="op">=</span> con.execute(<span class="st">"""</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT DISTINCT LSOA21CD</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM london_lsoa;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>).fetchdf()[<span class="st">'LSOA21CD'</span>].tolist()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into batches</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">250</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>batches <span class="op">=</span> [lsoa_codes[i:i <span class="op">+</span> batch_size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(lsoa_codes), batch_size)]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table before the loop if it doesn't exist</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="st">    CREATE TABLE IF NOT EXISTS london_LSOAs_vol (</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="st">        LSOA21CD VARCHAR PRIMARY KEY,</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="st">        borough VARCHAR,</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="st">        building_count INTEGER,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="st">        total_volume DOUBLE,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="st">        geom GEOMETRY</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="st">    )</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to SQL IN clause</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    code_list <span class="op">=</span> <span class="st">','</span>.join(<span class="ss">f"'</span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">'"</span> <span class="cf">for</span> code <span class="kw">in</span> batch)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create query to insert data into new london_LSOAs_vol table</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="ss">        INSERT INTO london_LSOAs_vol</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="ss">            l.LSOA21CD,</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="ss">            l.Borough AS borough,</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="ss">            COUNT(*) AS building_count,</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="ss">            SUM(b.volume) AS total_volume,</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="ss">            l.geom</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM london_lsoa l</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="ss">        JOIN buildings b</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="ss">        ON ST_Intersects(l.geom, ST_GeomFromText(b.geometry))</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="ss">        WHERE l.LSOA21CD IN (</span><span class="sc">{</span>code_list<span class="sc">}</span><span class="ss">)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="ss">        GROUP BY l.LSOA21CD, l.geom, l.Borough;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># execute the query created above</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    con.execute(query)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the building mass density</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Building Mass Density = LSOA area x total building volume</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate area for each LSOA (assuming CRS in meters)</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="st">    ALTER TABLE london_LSOAs_vol ADD COLUMN area_m2 DOUBLE;</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="st">    UPDATE london_LSOAs_vol</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="st">    SET area_m2 = ST_Area(geom);</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate building mass density for each LSOA</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="st">    ALTER TABLE london_LSOAs_vol ADD COLUMN building_mass_density DOUBLE;</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="st">    UPDATE london_LSOAs_vol</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="st">    SET building_mass_density = total_volume / area_m2;</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="heat-stress-vulnerability-index-hsvi" class="level3">
<h3 class="anchored" data-anchor-id="heat-stress-vulnerability-index-hsvi">Heat Stress Vulnerability Index (HSVI)</h3>
<p>Then we combine four factors above to calculate the index:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># okay so now we're going to normalise the data values  using sklearn min max scaler</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                    scaler <span class="op">=</span> MinMaxScaler()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># first we'll get the columns we want to normalise</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                    columns_to_normalise <span class="op">=</span> [<span class="st">"ndvi"</span>,<span class="st">"surface_temperature"</span>,<span class="st">"pct_over_65_pop"</span>,<span class="st">"building_density"</span>]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> column <span class="kw">in</span> columns_to_normalise:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                        raw_index_values_gdf_boroughs[<span class="ss">f"</span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">_normalised"</span>] <span class="op">=</span> scaler.fit_transform(raw_index_values_gdf_boroughs[[column]])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># st.write("Normalised dataframe")</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># st.dataframe(raw_index_values_gdf_boroughs)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># ------------------------------------------------------------</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                    normalised_columns <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> raw_index_values_gdf_boroughs.columns <span class="cf">if</span> <span class="st">"normalised"</span> <span class="kw">in</span> x]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> column <span class="kw">in</span> normalised_columns:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># now we're going to weight this by 25% for each of the normalised values</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                        raw_index_values_gdf_boroughs[<span class="ss">f"</span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">_weighted"</span>] <span class="op">=</span> raw_index_values_gdf_boroughs[column] <span class="op">*</span> <span class="fl">0.25</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># st.write("Weighted dataframe")</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                    weighted_df <span class="op">=</span> raw_index_values_gdf_boroughs[[<span class="st">"borough_name"</span>]<span class="op">+</span>[x <span class="cf">for</span> x <span class="kw">in</span> raw_index_values_gdf_boroughs.columns <span class="cf">if</span> <span class="st">"weighted"</span> <span class="kw">in</span> x] <span class="op">+</span> [<span class="st">"geometry"</span>]]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># st.dataframe(weighted_df)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># ------------------------------------------------------------</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># now lastly we're going to sum these up to get the final index values</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                    weighted_df[<span class="st">"index_value"</span>] <span class="op">=</span> weighted_df[[x <span class="cf">for</span> x <span class="kw">in</span> weighted_df.columns <span class="cf">if</span> <span class="st">"weighted"</span> <span class="kw">in</span> x]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                    weighted_columns <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> weighted_df.columns <span class="cf">if</span> <span class="st">"weighted"</span> <span class="kw">in</span> x]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># st.write("Final index dataframe")</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># st.dataframe(weighted_df.rename(columns={"borough_name":"Location"}).drop(columns=["geometry"]))</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># ------------------------------------------------------------</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="reference" class="level2">
<h2 class="anchored" data-anchor-id="reference">Reference</h2>
<p>Arup. (2024) Urban heat snapshot. Available at: <a href="https://www.arup.com/insights/publication-urban-heat-snapshot/">https://www.arup.com/insights/publication-urban-heat-snapshot/</a> (Accessed: 20 April 2025).</p>
<p>Bernard, J. et al.&nbsp;(2022) ‘Estimation of missing building height in OpenStreetMap data: a French case study using GeoClimate 0.0.1’, Geoscientific Model Development, 15(19), pp.&nbsp;7505–7532. Available at: <a href="https://doi.org/10.5194/gmd-15-7505-2022">(https://doi.org/10.5194/gmd-15-7505-2022)</a>.</p>
<p>Shindell, D., Hunter, R., Faluvegi, G., &amp; Parsons, L (2024). ‘Premature deaths due to heat exposure: The potential effects of neighborhood-level versus city-level acclimatization within US cities’, GeoHealth, 8.</p>
<p>United States Environmental Protection Agency (EPA) (2025) Measuring Heat Islands. Available at: <a href="https://www.epa.gov/heatislands/measuring-heat-islands">https://www.epa.gov/heatislands/measuring-heat-islands</a> (Accessed: 25 April 2025).</p>
<p>Wilby, R.L. (2003). ‘Past and projected trends in London’s urban heat island’, Weather, 58: 251-260.</p>
<p>World Health Organization. (2024) Heat and health. Available at: <a href="https://www.who.int/news-room/fact-sheets/detail/climate-change-heat-and-health">https://www.who.int/news-room/fact-sheets/detail/climate-change-heat-and-health</a> (Accessed: 20 April 2025).</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>